<!DOCTYPE html>
<html>
  <head>
    <title>ActivityPub</title>
    <meta charset='utf-8'>
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common'
            async class='remove'></script>
    <script class='remove'>
      var respecConfig = {
          specStatus: "ED",
          publishDate: "2016-08-23",
          previousPublishDate: "2016-06-14",
          previousMaturity: "WD",
          license: "w3c-software-doc",
          shortName:  "activitypub",
          wg: "Social Web Working Group",
          wgURI: "https://www.w3.org/Social/WG",
          wgPublicList: "public-socialweb",
          wgPatentURI: "https://www.w3.org/2004/01/pp-impl/72531/status",
          edDraftURI: "https://w3c-social.github.io/activitypub/",
          otherLinks: [
              {
                  "key": "Repository",
                  "data": [
                      {
                          "value": "Git repository",
                          "href": "https://github.com/w3c-social/activitypub",
                      },
                      {
                          "value": "Issues",
                          "href": "https://github.com/w3c-social/activitypub/issues",
                      },
                      {
                          "value": "Commits",
                          "href": "https://github.com/w3c-social/activitypub/commits/master",
                      }
                  ]
              }
          ],
          editors: [
                {
                    name:       "Christopher Allan Webber",
                    url:        "http://dustycloud.org/",
                    mailto:     "cwebber@dustycloud.org",
                    w3cid:      "57007"
                },
                {
                    name:       "Jessica Tallon",
                    url:        "http://theperplexingpariah.co.uk",
                    mailto:     "tsyesika@tsyesika.se",
                    w3cid:      "72695"
                },
          ],
          authors: [
              {
                  name:       "Owen Shepherd",
                  url:        "https://owenshepherd.net/",
                  mailto:     "owen.shepherd@e43.eu"
              },
              {
                  name: "Evan Prodromou",
                  url: "https://fuzzy.ai/about#evan",
                  company: "Fuzzy.ai",
                  companyUrl: "https://fuzzy.ai",
                  w3cid: "43626"
              },
          ],
          localBiblio:  {
            "ActivityStreams": {
              title:    "Activity Streams 2.0",
              href:     "https://www.w3.org/TR/activitystreams-core/",
              authors:  [
                "J. Snell",
              ],
              status:   "Editors Draft",
              publisher:  "ActivityStreams Working Group",
            },
            "Activity Vocabulary": {
              title:    "Activity Vocabulary",
              href:     "https://www.w3.org/TR/activitystreams-vocabulary/",
              authors:  [
                "J. Snell",
              ],
              status:   "Editors Draft",
              publisher:  "ActivityStreams Working Group",
            },
          },
      };
    </script>
  </head>
  <!-- STYLISTIC NOTE: This document wraps on column 79 and at the end of every
       sentence. -->
  <body>
    <section id='abstract'>
      <p>
        The ActivityPub protocol is a social networking protocol based upon the
        ActivityStreams 2.0 data format.
        It is based upon experience gained from implementing and working with
        the OStatus and Pump.io protocols.
      </p>
    </section>

    <section id='sotd'>
      <p>
        This document is a proposed submission to the W3C Social working group.
      </p>
    </section>

    <section id="Overview">
      <h2>Overview</h2>
      <p>
        The ActivityPub protocol is broadly based on the distribution of
        <i>activities</i>, described using [[!ActivityStreams]]; these
        activities are produced in response to a user performing an activity.
        Most activities are purely responsive in nature - they are produced as
        a response to a user <i>having</i> done something.
        In addition, certain activities posted by a user to their
        <a href="#outbox">outbox</a> may trigger certain operations on the
        user's behalf.
        Finally, activities may have side effects as they propagate throughout
        the social graph.
        As an example of this:
      </p>
      <ol>
        <li>
          A user posts the <code>like</code> activity to their outbox.
          This activity causes the user's server to perform an activity on
          behalf of the user; in particular, it adds the specified object to
          the collection of objects the user has liked.
        </li>
        <li>
          A consequence of the above activity (per
          <a href="#targeting"></a>) is that the server hosting the liked
          object will be notified of the operation, and will normally add the
          activity to the list of "likes" the object has received.
        </li>
        <li>
          Finally, the server receiving the like will distribute this activity
          to everyone it distributed the original object to.
        </li>
      </ol>

      <section id="social-web-working-group" inlist="" rel="schema:hasPart"
               resource="#social-web-working-group">
        <h3 property="schema:name">Social Web Working Group</h3>
        <div datatype="rdf:HTML" property="schema:description">
          <p>
            <a href="#Overview">ActivityPub</a> is one of several related
            specifications being produced by the Social Web Working Group.
            Implementers interested in alternative approaches and complementary
            protocols should review
            <a href="https://www.w3.org/TR/micropub/">MicroPub</a>
            and the overview document
            <a href="#bib-social-web-protocols" class="bibref">Social
              Web Protocols</a>.
          </p>
        </div>
      </section>
  
      <section id="specification-profiles">
        <h2>Specification Profiles</h2>
        <p>
          This specification defines two closely related and interacting
          protocols:
        </p>
        <dl>
          <dt>A client to server protocol, or "Social API"</dt>
          <dd>
            This protocol permits a client to act <i>on behalf</i> of a user.
            For example, this protocol is used by a mobile phone application to
            interact with the user's social stream.
          </dd>
          <dt>A server to server protocol, or "Federation Protocol"</dt>
          <dd>
            This protocol is used to distribute activities between users on
            different servers, tying them into one social graph.
          </dd>
        </dl>
        <p>
          All servers claiming conformance to this specification are required to
          implement the former protocol, and may optionally implement the latter.
          This gives three conformance classes:
        </p>
        <dl>
          <dt>ActivityPub conformant Client</dt>
          <dd>
            This designation applies to any implementation of the entirety of the
            client portion of the client to server protocol.
          </dd>
          <dt>ActivityPub conformant Server</dt>
          <dd>
            This designation applies to any implementation of the entirety of the
            server portion of the client to server protocol.
          </dd>
          <dt>ActivityPub conformant Federated Server</dt>
          <dd>
            This designation applies to any implementation of the entirety of the
            server portion of both the client to server and federation protocols.
          </dd>
        </dl>
        <p>
          It is called out whenever a portion of the specification only applies
          to implementation of the federation protocol.
          In addition, whenever requirements are specified, it is called out
          whether they apply to the client or server (for the client-to-server
          protocol) or which of a pair of servers in the server-to-server
          protocol.
        </p>
      </section>
    </section>


    <section id="obj">
      <h2>Objects</h2>
      <p>
        Objects are the core concept around which both [[!ActivityStreams]] and
        ActivityPub are built.
        Objects are often wrapped in Activities and are contained in streams of
        Collections, which are themselves subclasses of Objects.
        See the
        <a href="https://www.w3.org/TR/activitystreams-vocabulary/">ActivityStreams 
        Vocabulary</a> document, particularly the 
        <a href="https://www.w3.org/TR/activitystreams-vocabulary/#types">Core Classes</a>,
        to get a sense of how this lays out; ActivityPub follows the mapping of
        this vocabulary very closely.
      </p>
      <p>
        Servers SHOULD validate the content they receive to avoid content
        spoofing attacks.
        In particular, servers SHOULD NOT trust client submitted content, and
        federated servers also SHOULD NOT trust content received from a server
        other than the content's origin without some form of verification.
        The general mechanism that is specified for this at this time is for a
        recipient of some referenced activitystreams object to verify the
        presence of that object on the original server.
        Other mechanisms such as verifying signatures are left out of scope of
        this document.
        (However, if other generally agreed upon mechanisms for handling
        verification become available in the future, servers are welcome to use
        those methods, in the future.)
      </p>
      <div class="informative">
        As an example, if example.com receives the activity
        <pre class="example">
         {
           "type": "Like",
           "actor": "https://example.net/~mallory",
           "to": ["https://hatchat.example/sarah/",
                  "https://example.com/peeps/john/"],
           "object": {
             "id": "https://example.org/~alice/note/23",
             "type": "Note",
             "author": "https://example.org/~alice",
             "content": "I'm a goat"
           }
         }
        </pre>
        it should dereference the <code>id</code> both to ensure that it exists
        and is a valid object, and that it is not misrepresenting the object.
        (In this example, Mallory could be spoofing an object allegedly posted
        by Alice.)
      </div>
      <div class="issue">Mention requirement of <em>JSON-LD @context</em></div>
      <section id="obj-id">
        <h2>Object Identifiers</h2>
        <p>
          All Objects in [[!ActivityStreams]] should have unique global
          identifiers.
          ActivityPub extends this requirement; all objects distributed by the
          ActivityPub protocol MUST have unique global identifiers; these
          identifiers must fall into one of the following groups:
        </p>
        <ol>
          <li>
            Publicly dereferencable URIs, such as HTTPS URIs, with their
            authority belonging to that of their originating server.
            (Publicly facing content SHOULD use HTTPS URIs.)
          </li>
          <li>
            An ID explicitly specified as the JSON <code>null</code> object,
            which implies an anonymous object (a part of its parent context)
          </li>
        </ol>
        <p>
          Identifiers MUST be provided for activities posted in server to
          server communication.
          However, for client to server communication, a server receiving an
          object with no specified <code>id</code> should allocate an object ID
          in the user's namespace and attach it to the posted object.
        </p>
        <p>All objects must have the following properties:</p>
        <dl>
          <dt>id</dt><dd>The object's unique global identifier</dd>
          <dt>type</dt><dd>The type of the object</dd>
        </dl>
      </section>

      <section id="obj-methods">
        <h2>Methods on objects</h2>
        <p>
          The HTTP GET method may be dereferenced against an object's
          <code>id</code> property to retrieve the activity.
          Servers MAY use HTTP content negotiation as defined in [[!RFC7231]] to
          select the type of data to return in response to a request,
          but MUST present the ActivityStreams object representation
          in response to
          <code>application/ld+json; profile="https://www.w3.org/ns/activitystreams#"</code>,
          and SHOULD also present the ActivityStreams representation in
          response to <code>application/activity+json</code> as well.
          The client MUST specify an <code>Accept</code> header with the
          <code>application/ld+json; profile="https://www.w3.org/ns/activitystreams#"</code>
          media type in order to retrieve the activity.
        </p>
        <p>
          Servers MAY implement other behavior for requests which do not comply
          with the above requirement.
          (For example, servers may implement additional legacy protocols, or
          may use the same URI for both HTML and ActivityStreams
          representations of a resource)
        </p>
        <p>
          Servers MAY require authorization as specified in
          <a href="#authorization"></a>, and may additionally implement their
          own authentication rules.
          Servers SHOULD fail requests which do not pass their authorization or
          authentication checks with the appropriate HTTP error code, or the
          404 Not Found error code where the existence of the object is
          considered private.
        </p>
        <section id="method-get">
          <h2>The <code>GET</code> method</h2>
          <p>
            The HTTP GET method shall return an up-to-date version of the
            object.
          </p>
        </section>
      </section>
    </section>

    <section id="actors">
      <h2>Actors</h2>
      <p>
        Actors in ActivityPub are represented by HTTP URI.
        When entered directly into a user interface (for example on a login
        form), it is desirable to support simplified naming.
        For this purpose cases, ID normalization SHOULD be performed as
        follows:
      </p>
      <ol>
        <li>
          If the entered ID is a valid URI, then it is to be used directly.
        </li>
        <li>
          Otherwise, the entered value should be considered invalid.
        </li>
      </ol>
      <div class="issue">
        How to normalize entries without URI scheme, e.g. <em>tantek.com</em>
      </div>
      <p>
        Once the actor's URI has been identified, it should be dereferenced.
      </p>

      <section id="actor-objects">
        <h2><i>Actor</i> objects</h2>
        <p>
          Actor objects are ActivityStreams objects which are subclasses of the
          <code>Actor</code> type.
          Actor objects MUST have, in addition to the properties mandated by <a
          href="#obj-id"></a>, the following properties:
        </p>
        <dl>
          <dt>inbox</dt>
          <dd>
            A reference to an [[!ActivityStreams]] collection comprising of all
            the messages received by the actor; see <a href="#inbox"></a>.
          </dd>
          <dt>outbox</dt>
          <dd>
            An [[!ActivityStreams]] collection comprising of all the messages
            produced by the actor; see <a href="#outbox"></a>.
          </dd>
        </dl>
        <p>
          Implementations SHOULD, in addition, provide the following
          properties:
        </p>
        <dl>
          <dt>url</dt>
          <dd>
            A link to the actor's "profile web page", if it is not equal to the
            value of <code>id</code>.
          </dd>
          <dt>following</dt>
          <dd>
            An [[!ActivityStreams]] collection of the actors that this actor is
            following.
          </dd>
          <dt>followers</dt>
          <dd>
            An [[!ActivityStreams]] collection of the actors that follow this
            actor.
          </dd>
          <dt>name</dt>
          <dd>
            The preferred "nickname" or "display name" of the actor.
          </dd>
        </dl>
        <pre class="example">
          {
            "@context": [
              "https://www.w3.org/ns/activitystreams",
              "https://www.w3.org/ns/activitypub"
            ],
            "type": "Person",
            "id": "https://johnsmith.example.com/",
            "following": "https://johnsmith.example.com/following.json",
            "followers": "https://johnsmith.example.com/followers.json",
            "inbox": "https://johnsmith.example.com/inbox.json",
            "outbox": "https://johnsmith.example.com/feed.json",
            "preferredUsername": "johnsmith",
            "name": "John Smith",
            "summary": "Just an example guy",
            "icon": [
              "https://johnsmith.example.com/image/165987aklre4"
            ]
          }
        </pre>
        <p>Implementations MAY, in addition, provide the following properties:</p>
        <dl>
          <dt>streams</dt>
          <dd>
            A list of supplementary Collections which may be of interest.
          </dd>
          <dt>preferredUsername</dt>
          <dd>
            A short username which may be used to refer to the actor, with no
            uniqueness guarantees.
          </dd>
          <dt>summary</dt>
          <dd>A quick summary or bio by the user about themselves.</dd>
          <dt>icon</dt>
          <dd>
            A media link to the user's profile picture (this may be a
            thumbnail).
          </dd>
          <dt>endpoints</dt>
          <dd>
            A mapping of additional endpoints which may be useful either for
            this actor or someone referencing this actor.
          </dd>
        </dl>

        <p>
          The <code>endpoints</code> mapping MAY include the following
          properties:
        </p>
        <dl>
          <dt id="uploadMedia">uploadMedia</dt>
          <dd>
            Upload endpoint URI for this user for binary data.
          </dd>
          <dt id="proxyUrl">proxyUrl</dt>
          <dd>
            Endpoint URI so this actor's clients may access remote
            ActivityStreams objects which require authentication to access.
          </dd>
          <dt id="oauthClientAuthorize">oauthClientAuthorize</dt>
          <dd>
            If OAuth 2.0 bearer tokens are being used for authentication
            <a href="#client-to-server-interactions">client to server
              interactions</a>,
            this endpoint specifies a URI at which a browser-authenticated user
            may obtain a new access token.
          </dd>
        </dl>
      </section>

    </section>

    <section id="collections">
      <h2>Collections</h2>
      <p>
        [[!ActivityStreams]] defines the collection concept; ActivityPub
        defines several collections with special behavior.
        Note that ActivityPub makes use of
        <a href="https://www.w3.org/TR/activitystreams-core/#paging">
          ActivityStreams paging</a>
        to traverse large sets of objects.
      </p>

      <p>
        Note that some of these collections are specified to be of type
        <a href="https://www.w3.org/ns/activitystreams#OrderedCollection">
          <code>OrderedCollection</code></a>
        specifically, while others are permitted to be either a
        <a href="https://www.w3.org/ns/activitystreams#OrderedCollection">
          <code>Collection</code></a>
        or an
        <a href="https://www.w3.org/ns/activitystreams#OrderedCollection">
          <code>OrderedCollection</code></a>.
        An
        <a href="https://www.w3.org/ns/activitystreams#OrderedCollection">
          <code>OrderedCollection</code></a>
        MUST be presented consistently in reverse chronological order.
      </p>

      <section id="followers">
        <h2>Followers Collection</h2>
        <p>
          Every <a href="#actors">actor</a> SHOULD have a <code>followers</code>
          collection.
          This is a list of everyone who has sent a
          <a href="https://www.w3.org/TR/activitystreams-vocabulary/#dfn-follow">Follow</a>
          activity for the user, added as a
          <a href="#follow-activity-outbox">side effect</a>.
          This is where one would find a list of all the users that are
          following the actor.
          The <code>followers</code> collection MUST be either an
          <a href="https://www.w3.org/ns/activitystreams#OrderedCollection">
            <code>OrderedCollection</code></a>
          or a
          <a href="https://www.w3.org/ns/activitystreams#OrderedCollection">
            <code>Collection</code></a>.
        </p>

        <p class="note" title="Default for notification targeting">
          The follow activity generally is a request to see the objects a user
          creates. This makes the Followers collection an appropriate default
          target for <a href="#delivery">delivery</a> of notifications.
        </p>
      </section>

      <section id="following">
        <h2>Following Collection</h2>
        <p>
          Every actor MAY have a Following collection.
          This is a list of everybody that the actor has followed, added as a
          <a href="#follow-activity-outbox">side effect</a>.
          The <code>following</code> collection MUST be either an
          <a href="https://www.w3.org/ns/activitystreams#OrderedCollection">
            <code>OrderedCollection</code></a>
          or a
          <a href="https://www.w3.org/ns/activitystreams#OrderedCollection">
            <code>Collection</code></a>.
        </p>
      </section>

      <section id="likes">
        <h2>Likes Collection</h2>
        <p>
          Every actor MAY have a Likes collection.
          This is a list of every object from all of the actor's <code>Like</code> 
          activities, added as a <a href="#like-activity-outbox">side effect</a>.
          The <code>following</code> collection MUST be either an
          <a href="https://www.w3.org/ns/activitystreams#OrderedCollection">
            <code>OrderedCollection</code></a>
          or a
          <a href="https://www.w3.org/ns/activitystreams#OrderedCollection">
            <code>Collection</code></a>.
        </p>
      </section>

      <section id="outbox">
        <h2>Outbox</h2>
        <p>
          The outbox is discovered through the <code>outbox</code>
          property of an <a href="#actors">actor's</a> profile.
          The <code>outbox</code> MUST be an
          <a href="https://www.w3.org/ns/activitystreams#OrderedCollection">
            <code>OrderedCollection</code></a>.
        </p>
        <p>
          The outbox stream contains objects the user has
          published, subject to the ability of the requestor to retrieve the
          object (that is, the contents of the outbox are filtered by the
          permissions of the person reading it).
          If a user submits a request without
          <a href="#authorization">Authorization</a> the server should
          respond with all of the <a href="#public-addressing">Public</a>
          posts.
          This could potentially be all relevant objects published by the
          user, though the number of available items is left to the
          discretion of those implementing and deploying the server.
        </p>
        <p>
          The outbox accepts HTTP POST requests, with behaviour described in
          <a href="#client-to-server-interactions">Client to Server
            Interactions</a>.
        </p>
      </section>

      <section id="inbox">
        <h2>Inbox</h2>

        <p>
          The inbox is discovered through the <code>inbox</code>
          property of an <a href="#actors">actor's</a> profile.
          The <code>inbox</code> MUST be an
          <a href="https://www.w3.org/ns/activitystreams#OrderedCollection">
            <code>OrderedCollection</code></a>.
        </p>

        <p>
          The inbox stream contains all objects received by the
          user.
          The server SHOULD filter content according to the requester's
          permission.
          In general, the owner of an inbox is likely to be able to access
          all of their inbox contents. Depending on access control, some
          other content may be public, whereas other content may require
          authentication for non-owner users, if they can access the inbox
          at all.
        </p>

        <p>
          The server MUST perform de-duplication of activities returned by
          the inbox. Duplication can occur if an activity is addressed both 
          to a user's followers, and a specific
          user who also follows the recipient user, and the server has failed
          to de-duplicate the recipients list.
          Such deduplication MUST be performed by comparing the
          <code>id</code> of the activities and dropping any activities
          already seen.
        </p>

        <p>
          The inbox accepts HTTP POST requests, with behaviour described
          in <a href="#delivery">Delivery</a>.
        </p>
      </section>

      <section id="public-addressing">
        <h2>Public Addressing</h2>
        <p>
          In addition to [[!ActivityStreams]] collections and objects,
          Activities may additionally be addressed to the special "public"
          collection denoted by:
        </p>
        <pre class="example">
          {
            "@context": "https://www.w3.org/ns/activitystreams",
            "id": "https://www.w3.org/ns/activitypub/Public",
            "type": "Collection"
          }
        </pre>
        <p>
          Activities addressed to this special URI shall be accessible to all
          users, without authentication.
        </p>
        <p class="note" title="TODO: namespace">
          New URI for AP? Or can we get as:public?
        </p>
      </section>
    </section>

    <section id="binary-data">
      <h2>Binary Data</h2>
      <p>
        There is the ability to submit binary data such as images, video or
        other binary data you wish to use in ActivityPub.
        This is done by means of submitting the binary data to the user's
        <a href="#uploadMedia"><code>uploadMedia</code></a> on their
        ActivityStreams profile object.
        The request MUST contain the HTTP headers <code>Content-Type</code> and
        <code>Content-Length</code>.
        A client should expect that it must be
        <a href="#authorization-user-bearer">properly authenticated</a> in order
        to be able to upload media.
        Upon successful submission a response containing the object with an ID
        is returned that can be posted to the users outbox.
      </p>

      <p>An example response for an image I might upload is:</p>
      <pre class="example">
        {
          "@context": "",
          "id": "https://example.com/~erik/photos/1",
          "type": "Image",
          "to": ["https://example.com/~erik/public",
                 "https://example.org/~sarah/"],
          "cc": ["https://example.com/~erik/followers"],
          "url": [
            {
              "type": "Link",
              "href": "https://example.com/~erik/photos/1.png",
              "mediaType": "image/png"
            }
          ]
        }
      </pre>
    </section>

    <section id="client-to-server-interactions">
      <h2>Client to Server Interactions</h2>
      <p>
        Activities as defined by [[!ActivityStreams]] are the core mechanism
        for creating, modifying and sharing content within the social graph.
        Client to server interaction takes place through clients posting
        activities to a user's <a href="#outbox">outbox</a>.
      </p>

      <p>
        <!-- TODO: right..?? -->
        <strong>Clients</strong> are responsible for addressing new Activites
        appropriately.
        To some extent, this is dependent upon the particular client
        implementation, but clients must be aware that the server will only
        forward new Activities to addressees in the <code>to</code>,
        <code>cc</code> and <code>bcc</code> fields.
      </p>
      <p>
        Clients MAY address new Activities to the user's
        <a href="#followers">Followers Collection</a>
        or the <a href="#public-addressing">Public Collection</a> by default.
      </p>
      <p>
        Clients SHOULD check any objects attached to the Activity via the 
        <code>object</code>, <code>target</code>, <code>inReplyTo</code> and/or 
        <code>tag</code> fields, retrieve <em>their</em> <code>actor</code> or 
        <code>attributedTo</code> properties, and MAY also retrieve their addressing 
        properties, and add these to the <code>to</code> or <code>cc</code> 
        fields of the new Activity being created.
        Clients MAY recurse through attached objects, but if doing so, SHOULD
        set a limit for this recursion.
      </p>
      <p>
        Clients MAY give the user the chance to amend this addressing in the 
        UI.
      </p>
      <p>
        For example, when Chris likes the following article by Amy:
      </p>

      <pre class="example" title="An Article">
{
  "id": "https://rhiaro.co.uk/2016/05/minimal-activitypub",
  "type": "Article",
  "name": "Minimal ActivityPub update client",
  "content": "Today I finished morph, a client for posting ActivityStreams2...",
  "attributedTo": "<strong>https://rhiaro.co.uk/#amy</strong>",
  "to": "<strong>https://rhiaro.co.uk/followers/</strong>", 
  "cc": "<strong>https://e14n.com/evan</strong>"
}
      </pre>

      <p>the like is generated by the client as:</p>

      <pre class="example" title="A Like of the Article">
{
  "@context": "https://www.w3.org/ns/activitystreams#",
  "type": "Like",
  "actor": "https://dustycloud.org/chris/"
  "name": "Chris liked 'Minimal ActivityPub update client'",
  "object": "https://rhiaro.co.uk/2016/05/minimal-activitypub",
  "to": ["<strong>https://rhiaro.co.uk/#amy</strong>",
         "https://dustycloud.org/followers",
         "<strong>https://rhiaro.co.uk/followers/</strong>"],
  "cc": "<strong>https://e14n.com/evan</strong>"
}
      </pre>

      <p>The receiving outbox can then perform <a href="#delivery">delivery</a>
      to not only the followers of Chris (the liker), but also to Amy, and Amy's
      followers and Evan, both of whom received the original article.</p>

      <p>
        To submit new Activities to a user's server, clients MUST discover
        the URL of the user's <strong><a href="#outbox">outbox</a></strong> 
        from their <a href="#actor-objects">profile</a> and then MUST make an 
        HTTP <code>POST</code> request to to this URL with the Content-Type of
        <code>application/ld+json; profile="https://www.w3.org/ns/activitystreams#"</code>.
        The request MUST be authenticated with the credentials of the user to 
        whom the outbox belongs.
        The body of the <code>POST</code> request MUST contain a single
        Activity (which MAY contain embedded objects), or a single non-Activity
        object which
        <a href="#object-without-create">will be wrapped in a Create activity
          by the server</a>.
      </p>
      <pre class="example" title="Submitting an Activity to the Outbox">
POST /outbox/ HTTP/1.1
Host: dustycloud.org
Authorization: Bearer XXXXXXXXXXX
Content-Type: application/ld+json; profile="https://www.w3.org/ns/activitystreams#"

{
  "@context": "https://www.w3.org/ns/activitystreams#",
  "type": "Like",
  "actor": "https://dustycloud.org/chris/"
  "name": "Chris liked 'Minimal ActivityPub update client'",
  "object": "https://rhiaro.co.uk/2016/05/minimal-activitypub",
  "to": ["https://dustycloud.org/followers", "https://rhiaro.co.uk/followers/"],
  "cc": "https://e14n.com/evan"
}
      </pre>
      <p>
        If an Activity is submitted with a value in the <code>id</code> 
        property, servers MUST ignore this and generate a new <code>id</code>
        for the Activity.
        Servers MUST return a <code>201 Created</code> HTTP code with the new
        URL in the <code>Location</code> header.
      </p>
      <pre class="example" title="Outbox response to submitted Activity">
HTTP/1.1 201 Created
Location: https://dustycloud.org/likes/345
      </pre>
      <p>
        The server adds this new Activity to the <a href="#outbox">outbox</a>
        collection. 
        Depending on the type of Activity, servers may then be required to 
        carry out further side effects.
        These are described per individual Activity below.
      </p>

      <section id="create-activity-outbox">
        <h3>Create Activity</h3>
        <p>
          The <code>Create</code> activity is used to when posting a new object.
          This has the side effect that the object embedded within the Activity
          (in the <code>object</code> property) is created.
        </p>
        <p>
          When a <code>Create</code> activity is posted, the <code>actor</code>
          of the activity SHOULD be copied onto the <code>object</code>'s
          <code>attributedTo</code> field.
        </p>
        <p>
          A mismatch between addressing of the Create activity and its
          <code>object</code> is likely to lead to confusion.
          As such, a server SHOULD copy any recipients of the Create activity
          to its <code>object</code> upon initial distribution, and likewise
          with copying recipients from the <code>object</code> to the wrapping
          Create activity.
          Note that it is acceptable for the <code>object</code>'s addressing
          may be changed later without changing the <code>Create</code>'s
          addressing (for example via an <code>Update</code> activity).
        </p>

        <section id="object-without-create">
        <h4>Object creation without a Create Activity</h4>
        <p>
          For client to server posting, it is possible to create a new object
          without a surrounding activity.
          The server MUST accept a valid [[!ActivityStreams]] object that
          isn't a subtype of <code>Activity</code> in the POST request to the 
          outbox.
          The server then MUST attach this object as the <code>object</code>
          of a <a href="#create-activity-outbox">Create Activity</a>.
        </p>

        <p class="note">
          The <code>Location</code> value returned by the server should be the URL of 
          the new Create activity (rather than the object).
        </p>

        <p>
          The audience specified on the object MUST be copied over to
          the new Create activity by the server.
        </p>

        <pre class="example" title="Object with audience targeting">
        {
          "@context": "https://www.w3.org/ns/activitystreams",
          "type": "Note",
          "content": "This is a note",
          "published": "2015-02-10T15:04:55Z",
          "to": ["https://example.org/~john/"],
          "cc": ["https://example.com/~erik/followers"]
        }
        </pre>

        The above example could be converted to this:
        <pre class="example" title="Create Activity wrapper generated by the server">
        {
          "@context": "https://www.w3.org/ns/activitystreams",
          "type": "Create"
          "id": "https://example.net/~mallory/87374"
          "actor": "https://example.net/~mallory",
          "object": {
            "id": "https://example.com/~mallory/note/72",
            "type": "Note",
            "attributedTo": "https://example.net/~mallory",
            "content": "This is a note",
            "published": "2015-02-10T15:04:55Z",
            "to": ["https://example.org/~john/"],
            "cc": ["https://example.com/~erik/followers"]
          },
          "published": "2015-02-10T15:04:55Z",
          "to": ["https://example.org/~john/"],
          "cc": ["https://example.com/~erik/followers"]
        }
        </pre>
        </section>
      </section>
      <section id="update-activity-outbox">
        <h3>Update Activity</h3>
        <p>
          The <code>Update</code> activity is used when updating an already
          existing object.
          The side effect of this is that the <code>object</code> MUST be 
          modified to reflect the new structure in defined in the update 
          activity.
        </p>
      </section>
      <section id="delete-activity-outbox">
        <h3>Delete Activity</h3>
        <p>
          The <code>Delete</code> activity is used to delete an already
          existing object.
          The side effect of this is that the server MAY replace the
          <code>object</code> with a <code>Tombstone</code> of the object 
          that will be displayed in activities which reference the deleted
          object.
          If the deleted object is requested the server SHOULD respond with
          either the HTTP 410 Gone status code if a <code>Tombstone</code> is
          used, otherwise respond with a HTTP 404 Not Found.
        </p>

        <p>
          A deleted object:
          <pre class="example">
            {
              "@context": "https://www.w3.org/ns/activitystreams",
              "id": "https://example.com/~alice/note/72",
              "type": "Tombstone",
              "published": "2015-02-10T15:04:55Z",
              "updated": "2015-02-10T15:04:55Z",
              "deleted": "2015-02-10T15:04:55Z",
            }
          </pre>
        </p>
      </section>
      <section id="follow-activity-outbox">
        <h3>Follow Activity</h3>
        <p>
          The <code>Follow</code> activity is used to subscribe to the
          activities of another user.
        </p>
        <p>
          The side effect of receiving this in an <strong>outbox</strong>
          is that the server SHOULD add the <code>object</code> to the 
          <code>actor</code>'s <a href="#following">Following Collection</a>.
        </p>
      </section>
      <section id="add-activity-outbox">
        <h3>Add Activity</h3>
        <p>
          Upon receipt of an <code>Add</code> activity into the 
          <strong>outbox</strong>, the server SHOULD
          add the <code>object</code> to the collection specified in the 
          <code>target</code> property, unless:
        </p>
        <ul>
          <li>
            the <code>target</code> is not owned by the receiving 
            user, and thus they can't update it.
          </li>
          <li>
            the <code>object</code> is not allowed to be added to the
            <code>target</code> collection for some other reason, at the 
            receiver's discretion.
          </li>
        </ul>
      </section>
      <section id="remove-activity-outbox">
        <h3>Remove Activity</h3>
        <p>
          Upon receipt of a <code>Remove</code> activity into the 
          <strong>outbox</strong>, the server SHOULD
          remove the <code>object</code> from the collection specified in the 
          <code>target</code> property, unless:
        <ul>
          <li>
            the <code>target</code> is not owned by the receiving server, and
            thus they can't update it.
          </li>
          <li>
            the <code>object</code> is not allowed to be added to the
            <code>target</code> collection for some other reason, at the
            receiver's discretion.
          </li>
        </ul>
      </section>
      <section id="like-activity-outbox">
        <h3>Like Activity</h3>
        <p>
          The <code>Like</code> activity indicates the <code>actor</code> likes
          the <code>object</code>.
        </p>
        <p>
          The side effect of receiving this in an <strong>outbox</strong>
          is that the server MAY add the <code>object</code> to the 
          <code>actor</code>'s <a href="#likes">Likes Collection</a>.
        </p>
      </section>
      <section id="block-activity-outbox">
        <h3>Block Activity</h3>
        <p>
          The <code>Block</code> activity is used to indicate that the actor
          does not want a user (defined in the <code>object</code> property) to
          be able to interact with objects posted by the user.
          The server SHOULD prevent the user from interacting with any object
          posted by the actor.
        </p>
        <p>
          Servers SHOULD NOT deliver Block Activities to their <code>object</code>.
        </p>
      </section>
      <section id="undo-activity-outbox">
        <h3>Undo Activity</h3>
        <p>
          The <code>Undo</code> activity is used to undo a previous activity.
          For example, <code>Undo</code> may be used to undo a previous
          <code>Like</code> or <code>Follow</code>.
          The undo activity and the activity being undone MUST both have the
          same author.
          Side effects (such as adding activities to a user's inbox after a
          <code>Follow</code>) should be undone, to the extent possible.
        </p>

        <p>
          There are some exceptions where there is an existing and explicit
          "inverse activity" which should be used instead.
          <code>Create</code> based activities should instead use
          <code>Delete</code>, and <code>Add</code> activities should use
          <code>Remove</code>.
        </p>
      </section>

      <section id="client-to-server-outbox-delivery">
        <h3>Delivery</h3>
        <p>
          Federated servers MUST perform delivery on all Activities posted to the
          <strong>outbox</strong> according to <a href="#outbox-delivery">
          outbox delivery</a>.
        </p>
      </section>
    </section>

    <section id="server-to-server-interactions">
      <h2>Server to Server Interactions</h2>
      <p>
        Servers communicate with other servers and propagate information across
        the social graph by posting activities to actors' <strong>inbox</strong>
        endpoints.
        An Activity sent over over the network SHOULD have an <code>id</code>,
        unless it is intended to be transient (in which case it MAY omit the
        <code>id</code> or use a fragment identifier).
      </p>
      <p>
        In order to propagate updates throughout the social graph, Activities
        are sent to the appropriate recipients.
        First, these recipients are determined through following the
        appropriate links between objects until you reach an agent
        (<a href="#targeting">targeting</a>), and then the Activity is inserted
        into the agent's <em>inbox</em> (<a href="#delivery">delivery</a>).
        This allows recipient servers to:
      </p>
      <ul>
        <li>
          conduct any side effects related to the Activity (for example,
          notification that a user has liked an object is used to update the
          object's like count);
        </li>
        <li>
          deliver the Activity to recipients of the original object, to ensure
          updates are propagated to the whole social graph (see <a href=#inbox-delivery>
          inbox delivery</a>).
        </li>
      </ul>
      <p>Delivery is usually triggered by, for example:</p>
      <ul>
        <li>
          an Activity being created in a user's <a href="#outbox">outbox</a>
          with their <a href="#followers">Followers Collection</a> as the
          recipient.
        </li>
        <li>
          an Activity being created in a user's <a href="#outbox">outbox</a>
          with directly addressed recipients.
        </li>
        <li>
          an Activity being created in a user's <a href="#outbox">outbox</a> or
          <a href="#inbox">inbox</a> which references another object.
        </li>
      </ul>

      <section id="targeting">
        <h2>Targeting</h2>
        <p>
          Primary targeting is per the audience targeting properties from the
          [[!ActivityStreams]] specification.
          Notification targeting ensures the owners of all linked objects are
          notified of a new Activity that relates to them.
          Thus, the target(s) for delivery of an Activity may be:
        </p>

        <ul>
          <li>
            <strong>Primary targeting:</strong> the values of the
            <code>to</code>, <code>cc</code> or <code>bcc</code> fields (likely
            to include the <a href="#followers">followers</a> collection)
          </li>

          <li>
            <strong>Notification targeting:</strong> the <code>actors</code>
            for all objects in the <code>object</code>, <code>target</code>,
            <code>inReplyTo</code> or <code>tag</code> fields
          </li>
        </ul>

        <p>
          If the entry is a collection, then the server MUST dereference the
          collection (with the user's credentials) and discover inboxes for
          each item in the collection.
          Servers MUST limit the number of layers of indirections through
          collections which will be performed, which MAY be one.
        </p>
        <p>
          Servers MUST de-duplicate the final recipient list. Servers MUST also
          exclude actors from the list which are the same as the <code>actor</code>
          of the Activity being notified about.
        </p>

        <p class="note" title="Silent and private activities">
          What to do when there are no recipients specified is not defined,
          however it's recommended that if no recipients are specified the
          object remains completely private and access controls restrict the
          access to object.
          If the object is just sent to the "public" collection the object is
          not delivered to any users but is publicly viewable in the actor's
          outbox.
        </p>
      </section>

      <section id="delivery">
        <h2>Delivery</h2>
        <p>
          Once the target(s) for delivery have been determined, discovery of the
          recipient <a href="#inbox">inbox(es)</a>, and delivery, are performed
          according to [[!LDN]].
        </p>

        <p>
          In summary, the <a href="#inbox">inbox</a> is determined through the
          <code>inbox</code> property in the actor's profile.
          An HTTP POST request (with authorization of the submitting user) is
          then made to to the <a href="#inbox">inbox</a>, with the Activity as
          the body of the request.
          This Activity is added by the receiver as an <code>item</code> in the
          <a href="#inbox">inbox</a> OrderedCollection.
        </p>

        <p>For federated servers performing delivery to a 3rd party server,
          delivery SHOULD be performed asynchronously to completion of the
          original activity submission request, and SHOULD additionally retry
          delivery to recipients if it fails due to network error.</p>

        <section id="outbox-delivery">
          <h3>Outbox Delivery</h3>
          <p>
            When objects are received in the <a href="#outbox">outbox</a>, the
            server MUST target and deliver to:
          </p>
          <ul>
            <li>
              The <code>to</code>, <code>cc</code> or <code>bcc</code> fields
              if their values are individuals, or Collections owned by the server.
            </li>
          </ul>
          <p>
            These fields will have been <a href="#client-to-server-interactions">
            populated appropriately by the client</a> which posted the Activity
            to the outbox.
          </p>
        </section>

        <section id="inbox-delivery">
          <h3>Inbox Delivery</h3>
          <p>
            When Activities are received in the <a href="#inbox">inbox</a>, the
            server needs to forward these to recipients that the origin was unable
            to deliver them to. To do this, the server MUST <a href="#targeting">target</a>
            and <a href="#delivery">deliver</a> 
            to the values of <code>to</code>, <code>cc</code> and/or <code>bcc</code> 
            if and only if all of the following are true:
          </p>
          <ul>
            <li>This is the first time the server has seen this Activity.</li>
            <li>
              The values of <code>to</code>, <code>cc</code> and/or <code>bcc</code>
              contain a Collection owned by the server.
            </li>
            <li>
              The values of <code>inReplyTo</code>, <code>object</code>, 
              <code>target</code> and/or <code>tag</code> are objects owned by
              the server.
              The server SHOULD recurse through these values to look for linked objects
              owned by the server, and SHOULD set a maximum limit for recursion (ie. the
              point at which the thread is so deep the recipients followers may not mind
              if they are no longer getting updates that don't directly involve the 
              recipient). 
              The server MUST only target the values of <code>to</code>, <code>cc</code> 
              and/or <code>bcc</code> on the original object being forwarded, and not
              pick up any new addressees whilst recursing through the linked objects
              (in case these addressees were purposefully amended by or via the client).
            </li>
          </ul>
          <p>The server MAY filter its delivery targets according to implementation-specific
          rules, for example, spam filtering.</p>
        </section>
      </section>

      <section id="follow-activity-inbox">
        <h3>Follow Activity</h3>
        <p>
          The side effect of receving this in an <strong>inbox</strong> is
          that the server SHOULD add the <code>actor</code> to the <code>object</code>
          user's <a href="#followers">Followers Collection</a>.
        </p>
      </section>
      <section id="like-activity-inbox">
        <h3>Like Activity</h3>
        <p>
          The side effect of receving this in an <strong>inbox</strong> is
          that the server MAY increment the <code>object</code>'s count of 
          likes.
        </p>
      </section>
      <section id="add-activity-inbox">
        <h3>Add Activity</h3>
        <p>
          Upon receipt of an <code>Add</code> activity into the 
          <strong>inbox</strong>, the server SHOULD
          add the <code>object</code> to the collection specified in the 
          <code>target</code> property, unless:
        </p>
        <ul>
          <li>
            the <code>target</code> is not owned by the receiving server, and
            thus they can't update it.
          </li>
          <li>
            the <code>object</code> is not allowed to be added to the
            <code>target</code> collection for some other reason, at the
            receiver's discretion.
          </li>
        </ul>
      </section>
      <section id="remove-activity-inbox">
        <h3>Remove Activity</h3>
        <p>
          Upon receipt of a <code>Remove</code> activity into the 
          <strong>inbox</strong>, the server SHOULD
          remove the <code>object</code> from the collection specified in the 
          <code>target</code> property, unless:
        <ul>
          <li>
            the <code>target</code> is not owned by the receiving server, and
            thus they can't update it.
          </li>
          <li>
            the <code>object</code> is not allowed to be added to the
            <code>target</code> collection for some other reason, at the
            receiver's discretion.
          </li>
        </ul>
      </section>
    </section>

    <section id="authorization">
      <h2>Authorization</h2>
      <p><b>
        This is a stub, to be expanded. OAuth 2.0 is an open question.
      </b></p>
      <p>
        ActivityPub uses authorization for two purposes; first, to authenticate
        clients to servers, and secondly in federated implementations
        to authenticate servers to each other.
        These methods are based upon the OAuth 2.0 authorization framework as
        specified in [[!RFC6749]].
      </p>
      <section id="authorization-user">
        <h2>User Authentication</h2>
        <p>
          User authentication is used in order to identify clients acting on
          behalf of an <a href="#actors">actor</a> their origin server, and for
          federated implementations to other servers.
          There are two types of authentication permitted for this:
        </p>
        <section id="authorization-user-bearer">
          <h2>Bearer Authorization</h2>
          <p>
            For clients which only need to interact with the user's origin
            server, or communicating with a non-federated server, clients may
            use OAuth 2.0 bearer tokens.
          </p>
        </section>
        <section id="authorization-user-jws">
          <h2>JSON Web Signature authorization</h2>
          <p><b>
            This method is only mandatory for federated implementations
          </b></p>
          <p>
            For clients which need to interact with servers beyond the user's
            origin server, clients MUST support use of OAuth 2.0 with JSON Web
            Signatures.
          </p>
        </section>
      </section>
      <section id="authorization-origin">
        <h2>Origin Authorization</h2>
        <p><b>
          This method is only applicable to federated implementations
        </b></p>
        <p>
          A server performing an operation on behalf of an actor (e.g. delivery
          to a recipient) must authenticate itself with the 3rd party server as
          such.
          One method for doing so is defined in this specification.
        </p>
        <section id="authorization-origin-jws">
          <h2>JSON Web Signature authorization</h2>
          <p>
            Servers MUST support use of OAuth 2.0 with JSON Web Signatures.
          </p>
        </section>
      </section>
    </section>

    <section class="appendix informative">
      <h2>Change Log</h2>

      <section>
        <h3>Changes from 13 June 2016 to 23 June 2016</h3>

        <ul>
          <li>Various typo fixes.</li>
          <li>Clarification on file endpoint / binary uploads.</li>
          <li>Removed reference to HTTP PUT and DELETE verbs.</li>
          <li>Copy an activity's "actor" field to the "attributedTo" field.</li>
          <li>Restructuring and clarification around notification and delivery.</li>
          <li>Added Evan Prodromou and Owen Shepherd as authors to spec.</li>
          <li>
            Restructuring of document sections:
            <ul>
              <li>
                New, clearly delineated "Client to Server Interactions"
                and "Server to Server Interactions" sections.
              </li>
              <li>
                Server to server functionality now utilizes Linked Data
                Notifications.
              </li>
              <li>
                Moved activities section into the client to server / server to
                server sections, described as side effects.
              </li>
              <li>
                Collections moved earlier in document.
                Binary data section moved to after Collections.
              </li>
              <li>
                Notifications folded into targeting/delivery sections.
              </li>
            </ul>
          </li>
          <li>
            Removed duplicated content (endpoint discovery, inbox and outbox sections).
          </li>
          <li>
            When creating an object, return 201 created with Location header
            pointing to the Create activity.
          </li>
          <li>
            Moved some links from http to https.
          </li>
          <li>
            Clarify that objects may be submitted without a wrapping activity,
            and will be wrapped by Create on server.
          </li>
          <li>
            Clarification around removing content, Tombstones, expected http
            status on fetching removed objects.
          </li>
          <li>
            Describe delivery to collections not owned by replying user,
            forwarded by original poster.
          </li>
        </ul>
      </section>

      <section>
        <h3>Changes from 28 January 2016 WD to 13 June 2016</h3>

        <ul>
          <li>Various typo fixes.</li>
          <li>Moved following, followers, url to "SHOULD" properties.</li>
          <li>
            Removed objectTypes text and simplified "streams" definition.
          </li>
          <li>Removed vague term "share activity".</li>
          <li>Changed MAY to MUST for inbox reading.</li>
          <li>Replaced all "@type" and "@id" with "type" and "id".</li>
          <li>Clarified and fixed up followers section.</li>
          <li>Added "Note" type to receiving activity example.</li>
          <li>Dropped implied "@context" from an example.</li>
          <li>Added audience targeting to examples.</li>
          <li>Make inReplyTo more explicit.</li>
          <li>New text allowing silent and private activities.</li>
          <li>Removed reference to access control in Delivery section.</li>
          <li>Added section clarifying the ACL.</li>
          <li>Added an optional "streams" property example.</li>
          <li>
            Moved preferredUsername, summary, icon to "MAY" provideable actor
            properties.
          </li>
          <li>
            Clarified dereferencing collection to deliver to contained users.
          </li>
          <li>Require validating objects posted to inbox.</li>
          <li>Incoming activities MUST have a valid URI as id.</li>
          <li>Clarify when identifiers are required.</li>
          <li>
            Permit submitting objects without activities for client to server
            object creation.
          </li>
        </ul>
      </section>
    </section>
  </body>
</html>
